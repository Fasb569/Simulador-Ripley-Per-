<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Simulador Cr√©dito - Calendario Real</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }

    .card {
      background: #fff;
      padding: 0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin: auto;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    header {
      text-align: center;
      background: linear-gradient(135deg, #b268e4, #f89d25);
      color: white;
      padding: 20px;
      position: relative;
    }
    header h1 { margin: 0; font-size: 24px; font-weight: 700; }

    .logo { margin-bottom: 8px; }
    .logo img { max-width: 160px; height: auto; }

    /* Bot√≥n modo oscuro */
    .toggle-dark {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s;
    }
    .toggle-dark:hover { background: rgba(255,255,255,0.4); }

    /* üåô Estilos modo oscuro */
    body.dark {
      background: #1e1e1e;
      color: #f0f0f0;
    }
    body.dark .card {
      background: #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    body.dark .summary-block {
      background: #3a2a47;
      border-left: 6px solid #c28ef7;
    }
    body.dark table {
      background: #2a2a2a;
      color: #f0f0f0;
    }
    body.dark th { background: #884AB2; }
    body.dark tr:nth-child(even) { background: #333; }
    body.dark tr:hover { background: #4a3a5a; }
    body.dark input, body.dark select {
      background: #333;
      color: #f0f0f0;
      border: 1px solid #555;
    }
    body.dark button {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    /* üîπ Tarjetas resultados */
    .result-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      text-align: center;
      flex: 1;
      min-width: 120px;
      transition: background 0.3s, color 0.3s;
    }
    .result-card h3 {
      margin: 0;
      font-size: 16px;
      color: #884AB2;
    }
    .result-card p {
      margin: 5px 0 0;
      font-size: 18px;
      font-weight: 600;
    }

    /* üîπ Tarjetas resultados en modo oscuro */
    body.dark .result-card {
      background: #3a2a47;
      color: #f0f0f0;
    }
    body.dark .result-card h3 {
      color: #c28ef7;
    }

    .form-container {
      display: flex;
      gap: 25px;
      padding: 20px;
      flex-wrap: wrap;
    }

    h2 { color: #2c3e50; margin-bottom: 15px; font-size: 20px; }
    body.dark h2 { color: #f0f0f0; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    label {
      font-weight: 600;
      display: flex;
      flex-direction: column;
      font-size: 14px;
      color: #34495e;
    }
    body.dark label { color: #ddd; }

    input, select {
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    .actions { margin-top: 15px; display: flex; gap: 10px; }

    button {
      background: #884AB2;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.2s, background 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #FF930A;
      transform: scale(1.05);
    }

    .summary-block {
      margin: 0 20px 20px;
      padding: 20px;
      background: #f6e6ff;
      border-left: 6px solid #884AB2;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      transition: background 0.3s, color 0.3s;
    }
    .summary-block h2 { margin-top: 0; font-size: 20px; color: #2c3e50; }
    body.dark .summary-block h2 { color: #fff; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: background 0.3s, color 0.3s;
    }

    th, td { border: 1px solid #ddd; padding: 10px; font-size: 14px; }
    th { font-size: 13px; text-transform: uppercase; text-align: center; }
    td { text-align: right; }

    tr:nth-child(even) { background: #fafafa; }
    tr:hover { background: #f6e6ff; }

    @media (max-width: 900px) {
      .form-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Encabezado -->
    <header>
      <div class="logo">
        <img src="Logo_Atento.png" alt="Logo Atento Chile">
      </div>
      <h1>Simulador de Cr√©dito - Atento Ripley</h1>
      <button class="toggle-dark" onclick="toggleDarkMode()">üåô</button>
    </header>

    <!-- Contenedor formulario + tarjetas -->
    <div class="form-container">
      <!-- Formulario -->
      <div style="flex: 1.2;">
        <h2>Datos del cr√©dito</h2>
        <div class="form-grid">
          <label>Monto:
            <input type="number" id="monto" value="">
          </label>
          <label>TEA (%):
            <input type="number" id="tea" value="" step="0.01">
          </label>
          <label>Plazo (meses):
            <input type="number" id="plazo" value="">
          </label>
          <label>Seguro (% mensual sobre saldo):
            <select id="seguro">
              <option value="0.0035">Con Rescate (0.35%)</option>
              <option value="0.0030">Sin Rescate (0.30%)</option>
            </select>
          </label>
          <label>Fecha de desembolso:
            <input type="date" id="fecha" value="">
          </label>
          <label>D√≠a de pago:
            <input type="number" id="diaPago" value="">
          </label>
        </div>
        <div class="actions">
          <button onclick="calcular()"><i class="fa-solid fa-calculator"></i> Calcular</button>
          <button onclick="limpiar()" style="background:#FF5A5A;">
            <i class="fa-solid fa-broom"></i> Limpiar
          </button>
        </div>
      </div>

      <!-- Tarjetas resultados -->
      <div style="flex: 1; display:flex; flex-direction:column; gap:15px; justify-content:center;">
        <h2>Resultados clave</h2>
        <div style="display:flex; flex-wrap:wrap; gap:15px;">
          <div class="result-card"><h3>Cuota</h3><p id="res-cuota">--</p></div>
          <div class="result-card"><h3>TCEA</h3><p id="res-tcea">--</p></div>
          <div class="result-card"><h3>Intereses</h3><p id="res-intereses">--</p></div>
          <div class="result-card"><h3>Seguro</h3><p id="res-seguro">--</p></div>
        </div>
      </div>
    </div>

    <!-- Resumen consolidado -->
    <div id="resumen" class="summary-block">
      <h2>Resumen Consolidado</h2>
      <div id="resultados"><p><i>Complete los datos y presione Calcular...</i></p></div>
    </div>

    <!-- Tabla de cronograma -->
    <div id="cronograma"></div>
  </div>

<script>
function calcular() {
  let monto = parseFloat(document.getElementById("monto").value);
  let tea = parseFloat(document.getElementById("tea").value) / 100;
  let plazo = parseInt(document.getElementById("plazo").value);
  let seguroPct = parseFloat(document.getElementById("seguro").value);
  let fecha = new Date(document.getElementById("fecha").value);
  let diaPago = parseInt(document.getElementById("diaPago").value);

  if (isNaN(monto) || isNaN(tea) || isNaN(plazo) || isNaN(seguroPct) || isNaN(diaPago) || isNaN(fecha.getTime())) {
    alert("Por favor complete todos los campos.");
    return;
  }

  let td = Math.pow(1 + tea, 1/360) - 1;

  let fechas = [];
  let fechaPago = new Date(fecha);

  if (fechaPago.getDate() > diaPago) {
    fechaPago.setMonth(fechaPago.getMonth() + 2);
  } else {
    fechaPago.setMonth(fechaPago.getMonth() + 1);
  }
  fechaPago.setDate(diaPago);

  for (let i = 0; i < plazo; i++) {
    if (i > 0) fechaPago.setMonth(fechaPago.getMonth() + 1);
    fechas.push(new Date(fechaPago));
  }

  let diasArr = [], tiArr = [], fechaAnt = new Date(fecha);
  for (let f of fechas) {
    let dias = Math.round((f - fechaAnt)/(1000*60*60*24));
    diasArr.push(dias);
    let ti = Math.pow(1 + td, dias) - 1;
    tiArr.push(ti);
    fechaAnt = f;
  }

  function calcularCuota(monto, plazo, tiArr, seguroPct) {
    let cuotaMin = 0, cuotaMax = monto * 2, cuota = 0;
    for (let iter = 0; iter < 100; iter++) {
      cuota = (cuotaMin + cuotaMax) / 2;
      let saldo = monto;
      for (let i = 0; i < plazo; i++) {
        let interes = saldo * tiArr[i];
        let seguro = saldo * seguroPct;
        let amort = cuota - interes - seguro;
        saldo -= amort;
      }
      if (saldo > 0) { cuotaMin = cuota; } else { cuotaMax = cuota; }
    }
    return cuota;
  }

  let cuota = calcularCuota(monto, plazo, tiArr, seguroPct);

  let saldo = monto, totalIntereses = 0, totalSeguros = 0;
  let tabla = "<table><tr><th>N¬∞</th><th>Fecha</th><th>D√≠as</th><th>Saldo</th><th>Amortizaci√≥n</th><th>Inter√©s</th><th>Seguro</th><th>Cuota</th></tr>";

  fechaAnt = new Date(fecha);
  for (let i = 0; i < plazo; i++) {
    let interes = saldo * tiArr[i];
    let seguro = saldo * seguroPct;
    let amort = cuota - interes - seguro;
    tabla += `<tr>
      <td style="text-align:center;">${i+1}</td>
      <td style="text-align:center;">${fechas[i].toLocaleDateString()}</td>
      <td style="text-align:center;">${diasArr[i]}</td>
      <td>${saldo.toFixed(2)}</td>
      <td>${amort.toFixed(2)}</td>
      <td>${interes.toFixed(2)}</td>
      <td>${seguro.toFixed(2)}</td>
      <td>${cuota.toFixed(2)}</td>
    </tr>`;
    saldo -= amort;
    if (saldo < 0.01) saldo = 0;
    totalIntereses += interes;
    totalSeguros += seguro;
  }
  tabla += "</table>";

let flujos = [-monto];
let fechasFlujos = [new Date(fecha)];  // desembolso
saldo = monto;

for (let i = 0; i < plazo; i++) {
  let interes = saldo * tiArr[i];
  let seguro = saldo * seguroPct;
  let amort = cuota - interes - seguro;
  saldo -= amort;

  flujos.push(interes + seguro + amort);
  fechasFlujos.push(new Date(fechas[i]));  // las fechas reales de pago
}

// Usar XIRR con d√≠as reales
let irr = xirr(flujos, fechasFlujos);
let tcea = irr * 100; // XIRR ya devuelve anual

  // Actualizar tarjetas
  document.getElementById("res-cuota").innerText = cuota.toFixed(2);
  document.getElementById("res-tcea").innerText = tcea.toFixed(2) + "%";
  document.getElementById("res-intereses").innerText = totalIntereses.toFixed(2);
  document.getElementById("res-seguro").innerText = totalSeguros.toFixed(2);

  // Resumen consolidado
  document.getElementById("resultados").innerHTML = `
    <p><b>Monto:</b> ${monto.toFixed(2)}</p>
    <p><b>TEA:</b> ${(tea*100).toFixed(4)}%</p>
    <p><b>TEM:</b> ${((Math.pow(1+tea,1/12)-1)*100).toFixed(4)}%</p>
    <p><b>Plazo:</b> ${plazo} meses</p>
    <p><b>Cuota fija total:</b> ${cuota.toFixed(2)}</p>
    <p><b>Total intereses:</b> ${totalIntereses.toFixed(2)}</p>
    <p><b>Total seguro:</b> ${totalSeguros.toFixed(2)}</p>
    <p><b>TCEA:</b> ${tcea.toFixed(2)}%</p>
  `;

  document.getElementById("cronograma").innerHTML = tabla;
}

function tasaInternaRetorno(flujos, guess=0.02) {
  let maxIter = 1000, tol = 1e-10, rate = guess;
  for (let i = 0; i < maxIter; i++) {
    let npv = 0, derv = 0;
    for (let t = 0; t < flujos.length; t++) {
      npv += flujos[t] / Math.pow(1+rate, t);
      if (t > 0) derv += -t * flujos[t] / Math.pow(1+rate, t+1);
    }
    let newRate = rate - npv/derv;
    if (Math.abs(newRate - rate) < tol) return newRate;
    rate = newRate;
  }
  return rate;
}

function limpiar() {
  document.getElementById("monto").value = "";
  document.getElementById("tea").value = "";
  document.getElementById("plazo").value = "";
  document.getElementById("seguro").selectedIndex = 0;
  document.getElementById("fecha").value = "";
  document.getElementById("diaPago").value = "";
  document.getElementById("res-cuota").innerText = "--";
  document.getElementById("res-tcea").innerText = "--";
  document.getElementById("res-intereses").innerText = "--";
  document.getElementById("res-seguro").innerText = "--";
  document.getElementById("resultados").innerHTML = "<p><i>Complete los datos y presione Calcular...</i></p>";
  document.getElementById("cronograma").innerHTML = "";
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
  const btn = document.querySelector(".toggle-dark");
  btn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåë";
}
function xirr(flujos, fechas, guess=0.1) {
  let tol = 1e-7, maxIter = 100;
  let rate = guess;

  function f(rate) {
    let npv = 0;
    for (let i = 0; i < flujos.length; i++) {
      let t = (fechas[i] - fechas[0]) / (1000*60*60*24*365);
      npv += flujos[i] / Math.pow(1 + rate, t);
    }
    return npv;
  }

  for (let i = 0; i < maxIter; i++) {
    let f1 = f(rate);
    let f2 = f(rate + tol);
    let deriv = (f2 - f1) / tol;
    let newRate = rate - f1/deriv;
    if (Math.abs(newRate - rate) < tol) return newRate;
    rate = newRate;
  }
  return rate;
}
</script>
</body>

</html>


